<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Updating Web Services - Grants Pass GIS Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Home</a></li><li class="chapter-item expanded "><a href="addressing.html"><strong aria-hidden="true">2.</strong> Addressing Manual</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="address_request.html"><strong aria-hidden="true">2.1.</strong> The Address Request Form</a></li><li class="chapter-item expanded "><a href="addressing_layer.html"><strong aria-hidden="true">2.2.</strong> The Addressing Layer</a></li><li class="chapter-item expanded "><a href="addressing_rules.html"><strong aria-hidden="true">2.3.</strong> Addressing Rules</a></li><li class="chapter-item expanded "><a href="addressing_policies.html"><strong aria-hidden="true">2.4.</strong> Addressing Policies</a></li><li class="chapter-item expanded "><a href="address_verification.html"><strong aria-hidden="true">2.5.</strong> Address Verification</a></li><li class="chapter-item expanded "><a href="address_strategic_plan.html"><strong aria-hidden="true">2.6.</strong> Address Strategic Plan</a></li><li class="chapter-item expanded "><a href="lexisnexis.html"><strong aria-hidden="true">2.7.</strong> LexisNexis Tables</a></li></ol></li><li class="chapter-item expanded "><a href="publishing_services.html"><strong aria-hidden="true">3.</strong> Services</a></li><li class="chapter-item expanded "><a href="layer_files.html"><strong aria-hidden="true">4.</strong> Layer Files</a></li><li class="chapter-item expanded "><a href="survey_points.html"><strong aria-hidden="true">5.</strong> Survey Points</a></li><li class="chapter-item expanded "><a href="packages_intro.html"><strong aria-hidden="true">6.</strong> Packages</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="github.html"><strong aria-hidden="true">6.1.</strong> Github Integration</a></li><li class="chapter-item expanded "><a href="using_git.html"><strong aria-hidden="true">6.2.</strong> Using git</a></li><li class="chapter-item expanded "><a href="git_workflow.html"><strong aria-hidden="true">6.3.</strong> Git Workflow</a></li><li class="chapter-item expanded "><a href="virtual_env.html"><strong aria-hidden="true">6.4.</strong> Using a Virtual Environment</a></li><li class="chapter-item expanded "><a href="web_services_update.html" class="active"><strong aria-hidden="true">6.5.</strong> Updating Web Services</a></li></ol></li><li class="chapter-item expanded "><a href="utility_editing.html"><strong aria-hidden="true">7.</strong> Utility Editing</a></li><li class="chapter-item expanded "><a href="utility_network_creation.html"><strong aria-hidden="true">8.</strong> Utility Network Creation</a></li><li class="chapter-item expanded "><a href="scripts_intro.html"><strong aria-hidden="true">9.</strong> Stand-Alone Scripts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="missing_sidewalks.html"><strong aria-hidden="true">9.1.</strong> Missing Sidewalks</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Grants Pass GIS Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="updating-web-services"><a class="header" href="#updating-web-services">Updating Web Services</a></h1>
<p>For redundancy, we host our published GIS services both in our Enterprise portal as well as AGOL.
Services published to our Enterprise portal are referenced data, meaning that as we update our database, these changes will be reflected in the published service in near real-time.
However, the services published to AGOL are copied onto their servers, and will become out-of-date when additional changes are made to our database.
AGOL is often the preferred provider, because we are leveraging their server resources to deliver better performance, so the majority of services on our public-facing web viewer are reading from AGOL.
However, this also means we must periodically update the content on AGOL, so that the latest data is available to our users.</p>
<p>Here we delineate the steps to ensure a complete sync between our database and AGOL:</p>
<h2 id="step-one-reconcile-versions-in-the-city-editor"><a class="header" href="#step-one-reconcile-versions-in-the-city-editor">Step One: Reconcile Versions in the City Editor</a></h2>
<p>When city staff submit edits to a layer through the internal web viewer, they are modifying the DRAFT version of the database.
Likewise, the ArcGIS projects that we use to make edits are also pointed at the DRAFT version.
The version of our data shared with the public on our web viewer is the PRODUCTION/DEFAULT version.
In order for changes made in DRAFT to be visible to the public, we must first push these changes into the PRODUCTION version.</p>
<ul>
<li>You can reconcile versions in any ArcPro project by selecting the List by Data Source tab in the Contents pane, and clicking on the versioned layer.</li>
<li>A Version tab will appear in the menu ribbon, and selecting this tab will reveal a set of versioning options in the ribbon.</li>
<li>Click the Reconcile button (typically you will target the DEFAULT version, defining conflict by column and resolving conflicts in favor of the edit version).</li>
<li>When the reconcile has completed, use the Version Changes button to view the results.</li>
<li>When the version changes pane opens, select the Differences tab to view specific changes that will be pushed into production.</li>
<li>Click Post to push the changes to the PRODUCTION version.</li>
</ul>
<p>Review and approve changes before merging. If the changes are edits that you have personally made, the review process may be relatively brief. But if the changes are submitted by field crews and other staff, take a moment to inspect the differences and ensure that they are reasonable and well-formed. Defer to the expertise of field crews for establishing facts on the ground, but keep in mind they may need help to enter the data idiomatically, using the correct fields and domain values.</p>
<h2 id="step-two-push-utility-edits-to-beehive"><a class="header" href="#step-two-push-utility-edits-to-beehive">Step Two: Push Utility Edits to Beehive</a></h2>
<p>When edits include changes to any utility layer, we also need to push these changes to the Beehive mapping service that we use to for event management. Utility workers use the Beehive map to track recurring maintenance and record progress on their tasks, so from their perspective, if it has not been uploaded to Beehive, the update may as well have not occurred. Currently, we use the <em>beehive_push.mdx</em> project in ArcMap to update the Beehive layer. This can be found in the <em>GIS General\Public_Works_Projects directory</em>.</p>
<ul>
<li>Select all updated features in a layer.</li>
<li>Select the layer of interest in the contents pane.</li>
<li>Click the Beehive Update button.</li>
</ul>
<p>Per Mark Janz, I push point assets first, then line assets.</p>
<h2 id="step-three-stage-draft-services"><a class="header" href="#step-three-stage-draft-services">Step Three: Stage Draft Services</a></h2>
<p>Here we use a script that depends on methods in the <code>arcpy</code> module to stage draft services in a folder, so we can upload a new version of the service to AGOL.
To access <code>arcpy</code>, we have to use the version of Python installed with ArcGIS.
This is not the same as the version of Python we use for normal development, so we effectively have two versions of Python on our machine.
Since I have my IDE pointed at the latest/greatest version on my local machine, the script will fail to compile if I run it from my IDE, with a complaint that it cannot find the <code>arcpy</code> module.
I am sure there is a project-specific way to point the IDE at the correct Python version, but I have not explored this option.
Instead, when I need to run a script with <code>arcpy</code>, I run it from inside ArcPro.
In this case, still using the <em>city_editor</em> project, I open the python window and enter the commands:</p>
<pre><code class="language-{bash}">exec(open('c:/users/erose/repos/scripts/service_draft.py').read())
drafts.draft_services(base_path)
</code></pre>
<p>The first command opens the script located at the path location and runs the contents. This creates an object called <em>drafts</em>, containing methods for creating and staging the service drafts, including the <em>draft_services</em> method that we call here. The <em>base_path</em> variable is set to a folder on the O: drive. This folder contains the previous set of drafts, and gets overwritten with every call to this script. This is the same directory that we will read from when publishing the services in the next step.</p>
<p>The script <em>service_draft.py</em> includes logging messages, but these will not show up in ArcPro. We can pipe log messages into <code>arcpy</code>, but this is a different logging workflow from the normal python <em>logging</em> library, and I have not had a chance to learn it. Instead, I just want to read the logging messages that are already in there. To do that, open a terminal window and enter the command:</p>
<pre><code class="language-{bash}">Get-Content P:/service_update.log -Wait -Tail 0
</code></pre>
<p>If you have updated the location of the log file in <em>service_draft.py</em>, then you will need to update the path here.
The terminal will stay open and print any additions to the log file.
You can exit the listening state by pressing CTRL-C.
If you open the log file in a text editor, you can also read the contents, but the contents will not update upon new entries to the log, so I prefer watching the file from the terminal.
The main issue to watch out for are failures, cases where the service draft could not be staged.
Currently the output looks like this:</p>
<pre><code class="language-{bash}">09/30/2024 04:05:37 PM Exception ERROR 160069: The dataset was not found.
Failed to execute (StageService).
09/30/2024 04:05:37 PM Dropping planning.
</code></pre>
<p>In the above example, the <em>planning</em> service failed to update automatically. We will need to open the project file for this service and determine why it is failing to build. When the staging succeeds, the message will read "Draft staged for X". If you have made adjustments to a service, and wish to try staging the draft again for that service in particular, you can pass the service name in a vector to the <em>draft_services</em> method:</p>
<pre><code class="language-{bash}">drafts.draft_service(base_path, ["planning"])
</code></pre>
<h2 id="step-four-update-web-services"><a class="header" href="#step-four-update-web-services">Step Four: Update Web Services</a></h2>
<p>The <em>service_update.py</em> script uses the <code>arcgis</code> module to publish the draft services to AGOL. The <code>arcgis</code> module is an open-source Python package, unlike <code>arcpy</code>, so we can run it from the terminal using a Python virtual environment, as touched on <a href="./virtual_env.html">here</a>.</p>
<p>From within your virtual environment, navigate to the <em>scripts</em> directory and enter the command:</p>
<pre><code class="language-{bash}">exec(open('login.py').read())
</code></pre>
<p>This will open a window in your browser asking you to approve the login. Click Approve, copy the SAML code and paste it into the terminal using CTRL-SHIFT-V. Once you have successfully authenticated, enter the command:</p>
<pre><code class="language-{bash}">exec(open('service_update.py').read())
</code></pre>
<p>When the script runs, it will print the following:</p>
<pre><code class="language-{bash}">Run: services.publish(gis, base_path, short)
</code></pre>
<p>The <em>services</em> object holds methods to read the contents of the service drafts directory and upload the services to AGOL, including the <em>publish</em> method invoked here.
The <em>gis</em> variable holds the AGOL portal connection, and <em>base_path</em>, as before, points to the directory containing the service drafts.
The <em>short</em> variable contains the subset of services that receive frequent updates. For services that do not update often, it is wasteful to rebuild the services if no changes have occurred.
As with the <em>draft_services</em> method, you can substitute a vector of service names in place of <em>short</em>.
Indeed, if you print the contents of <em>short</em>, it shows you the vector of service names to update by "default":</p>
<pre><code class="language-{python}">&gt; short
['agreements', 'historic_cultural_areas', 'land_use', 'impervious_surface', 'merlin_landfill', 'parking', 'parks', 'planning', 'regulatory_boundaries', 'sewer_utilities', 'stormwater', 'transportation', 'water_utilities', 'zoning']
</code></pre>
<p>The services that typically fail to update are <em>historic_cultural_areas</em>, <em>water_utilities</em>, <em>sewer_utilities</em>, and <em>transportation</em>. The issue may be related to amount of data in the service, which may be leading to time-outs during the upload stage. For each service that fails to update by script, I open the ArcPro project associated with the service, and republish the service from there.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="virtual_env.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="utility_editing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="virtual_env.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="utility_editing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
